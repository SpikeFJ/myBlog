
# 一. 预备知识：

* 内网访问外网时，路由器/防火墙会将内网机器(**源IP端口**)的ip和端口改写，包装成自己的IP+随机端口

* 路由器/防火墙在包装Ip和端口时，不管 **目的IP端口** 是什么，只要来源ip端口一致则包装成成相同的IP端口

举例：
> Host1通过本地端口12345访问 XXXXXX:4567,如果经过路由器改写后的源IP端口是：1.1.1.1:5678

> 那么，Host1通过本地端口12345访问 YYYYYY:6789,出来的源IP端口也会是：1.1.1.1:5678

# 二. 流程分析
punch hole 程序分为两部分：服务端，客户端
流程如下：

1. `server`机器开启主要监听端口 `30000`
2. `clientA`、`clientB`各自通过端口`12345`访问服务端`30000`
```
   1.1.1.123:12345--->1.1.1.1:11111---->XXXX:30000
   2.2.2.456:12345--->2.2.2.2:22222—--->XXXX:30000
```

3. `clientA`向`server`请求所有在线客户端列表
4. `clientA`告诉`server`端我要连接`clientB`(2.2.2.2:22222)
```
   即1.1.1.123:12345---->2.2.2.2:22222

    1) 1.1.1.123:12345被包装成1.1.1.1:11111----2.2.2.2:22222
    2) 2.2.2.2是路由器，接受到数据后不知道转给谁，丢弃。

    但是客户端A的防火墙据此保留了一些信息，即：2.2.2.2:22222---->1.1.1.1:11111--->1.1.123:12345
```
5. `clientA`告诉服务端：让`clientB`用端口`12345`连接

```
clientA:1111-------->RouteA:1.1.1.

1:9676------------>Server:5555<-------------------RouteB:2.2.2.2:6573<---------------HostB:2222
1、A:1111--->2.2.2.2:6573
```

# 三. 重新整理
UserA :1.1.1.11:1234

RouteA:1.1.1.1:4321

UserB :2.2.2.22:5678

RouteB:2.2.2.2：8765

Server:3.3.3.3:30000

1. UserA登录Server，(此时Server检测到UserA的Ip端口是RouteA)
    1.1. Server通知UserA，当前所有在线终端
    1.2. Serer通知其他在线终端，UserA在线

2. UserB同步骤1
3. PunchHole（A--->B)

   3.1 UserA向Server请求PunchHole UserB

     3.1.1 Server通知UserB，UserA想PunchHole
     
     3.1.2 UserB接受到Server，UserA想PunchHole，UserB-->UserA，此时会失败，因为UserB发送给RouteA，RouteA不知道转给谁。

   3.2 UserA--->UserB发送连接测试