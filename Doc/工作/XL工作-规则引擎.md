# 一. 典型场景

在之前的工作中，遇到这样一个需求：

>  当 温度传感器 监测到温度 到达30 ℃时，则开启 空调

整理分类下有以下几种场景,按照触发的类型：

```java
* 1. 瞬时数据判断
*      1)单个数据判断
           A设备温度超过 38 ，发送短信报警/ B设备开启
*      2)多个数据联合判断
*          A设备温度超过38，且当前B设备处于XX状态，则开启B设备/发送短信报警/ C设备开启
*
*   瞬时数据，需要在数据产生方通过消息中间件传递通知，通知包括数据本身，避免消费方再次主动查询。
*
* 2. 过程数据判断
*     1) A设备持续N分钟没有数据
*        从A设备的最后一次有数据计算，所以每次数据到达时，都要开始一个计算任务
*
*     2) A设备持续N分钟数据越限
*        从A设备的最后一次有数据计算，所以每次数据到达时，都要开始一个计算任务
*
*
```

上面流程简化下就是 

>  当 满足某个 **条件** 时，执行某个 **动作**

这和IFTTT(If this then that)理念比较近似，所以这里先介绍先

# 二. IFTTT

「如果Flickr上传新图片，那么就自动保存到Dropbox」，Flickr 就是触发器频道，Dropbox 就是动作频道。

![image-20200828105442283](https://i.loli.net/2020/08/28/jdlSkYC7qfwgopR.png)

所以，IFTTT 创建一个「Recipes 流程」的流程如下：

选择一个触发器频道，设置它的触发条件，再选择一个动作频道，然后设置它要执行的动作。



具体的频道每个支持的「条件」和「动作」各不相同，应该根据实际需求来选择。

# 三. 回到需求

好的，我们再次回到需求本身

>  当 温度传感器 监测到温度 到达30 ℃时，则开启 空调

针对这个需求本身，我更愿意称整个流程是一个触发器，而不是一个`Recipe`，可能和数据库的触发器概念更为接近

触发器（`Trigger`）包括条件（`Condition`）和动作（`Action`）

条件应该以为具体的业务对象为载体，如设备、用户都有其专有的条件配置。

### 1.什么时候触发条件判断

   如果仅仅是单体应用，可以通过观察者模式来实现，如

> 当新建某个设备时，如果设备行政区域属于南京，则发信息给南京的负责人

可以在 设备的 `save`方法中通知 相关监听者，

但是回到开头的需求  温度数据 和 触发器判断程序 ，很大可能不是同一个应用。

所以必须通过某种机制来通讯，我们自然就会想到消息中间件,可以在多个监听器中进行消息写入，充当生产者

### 2. 消息传递什么

条件condition执行判断时，需要什么参数：

1. 业务对象肯定是需要的
2. 如果是数据类的判断，如温度，则需要传递温度值本身，避免再次主动查询

### 3. 条件如何判断

不同的业务对象，不同的触发类型，判断流程都不一致

但是都需要业务对象是**有状态**的，缺少这一支撑，判断就很难达成，如何理解：

> 当温度达到30摄氏度且空调是关闭的，则开启空调

转化为内部对象则是

> 当A传感器 上报数据30摄氏度 且 B设备.status =关闭， 则B设备.open

其中B设备的状态需要保存在应用中，以便后续判断。

### 4. 需要持久化吗

上述步骤中提到数据通过信息传递，状态数据也是，那么是否只需要在内存中接受并判断就可以了，

需要持久化吗？

如果程序需要重启或者意外重启，重启时当前的状态数据无法通过数据产生方主动消息通知，那么就需要重新加载状态数据，

所以需要持久化数据。

### 5. 过程数据如何判断

过程数据通俗来讲就是：判断连续多长时间没有数据/有异常数据后执行某个动作

时间跨度可以是：秒、分、时、日乃至月年。

过程数据判断涉及到有状态的数据更多，所以从性能角度考虑，数据最好持久化最好放在`redis`内存数据库中。



分为两种:

 1. 一种是没有数据持续多长时间则执行动作

    当数据到达时，如果当前有监测任务，则重置监测任务，将监测开始时间置为当前，持续时间为0；

    否则开启监测监测任务。

    

   2. 一种有数据，异常数据持续多长时间 

      当数据到达时，如果当前有监测任务，判断数据正常，则重置任务；异常则持续时间累加。

To Be Continue......

